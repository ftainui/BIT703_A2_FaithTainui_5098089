// Read product id from url
const params = new URLSearchParams(window.location.search);
const productId = Number(params.get("id"));

// Get product container
const container = document.querySelector(".product-page-container");

// Find product data
const product = products.find(p => p.id == productId);

// Find product details
const details = product;

// Build and populate product page
container.innerHTML = `
    <div class="product-page-left">
        <img src="${product.img}" alt="${product.name}">
    </div>

    <div class="product-page-right">
        <h2>${product.name}</h2>

        <p class="stars">
            ${"★".repeat(product.stars)}${"☆".repeat(5 - product.stars)}
        </p>
        <hr class="full-width-line">

       <div class="price-model-row">
            <span id="product-price" class="price">$${product.price}</span>

            ${details.models ? `
                <select id="product-model">
                    <option value="" disabled selected>Select model</option>
                    ${details.models.map(m => `<option value="${m}">${m}</option>`).join("")}
                </select>
            ` : ""}
        </div>
        <hr class="full-width-line">

        <p class="description">${details.description}</p>
        <hr class="small-line">

        <button class="add-cart-btn">Add to Cart</button>
    </div>
`;

// Similar products from category
const similarProductsContainer = document.querySelector(".similar-products-grid");
const similarProducts = products
    .filter(p => p.category === product.category && p.id !== product.id)
    .slice(0, 3); // only show 3

similarProductsContainer.innerHTML = "";

similarProducts.forEach(p => {
    const card = document.createElement("a");
    card.href = `product_detail.html?id=${p.id}`;
    card.classList.add("similar-product-card");

    card.innerHTML = `
        <img src="${p.img}" alt="${p.name}">
        <p class="product-name">${p.name}</p>
        <p class="product-price">$${p.price}</p>
    `;
    similarProductsContainer.appendChild(card);
});

// Get container for reviews
const reviewsContainer = document.querySelector(".product_reviews");

// Clear any existing reviews
reviewsContainer.innerHTML = "";

// Display reviews
if (product && product.reviews) {
    product.reviews.forEach(review => {
        const div = document.createElement('div');
        div.classList.add('review-item');
        div.innerHTML = `
            <img src="${review.userImg}" alt="${review.userName}" class="review-user">
            <div class="review-meta">
                <span class="user-name">${review.userName}</span>
                <span class="review-date">${review.date}</span>
                <span class="review-stars">${'★'.repeat(review.rating)}${'☆'.repeat(5 - Math.ceil(review.rating))}</span>
            </div>
            <p class="review-text">${review.text}</p>
        `;
        reviewsContainer.appendChild(div);
    });
}

// Get add to cart button
const addCartBtn = container.querySelector(".add-cart-btn");

// Attach add to cart functionality
addCartBtn.addEventListener("click", () => {
    const modelDropdown = document.querySelector("#product-model");

    // If the product has models, enforce selection
    if (details.models && modelDropdown.value === "") {
        modelDropdown.style.border = "2px solid red";
        alert("Please select a model first.");
        return; // Stop here — do NOT add to cart
    }

    // Reset border once valid
    if (details.models) {
        modelDropdown.style.border = "1px solid #ccc";
    }

    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    const existing = cart.find(item => item.id === product.id);

    const selectedModel = modelDropdown ? modelDropdown.value : "";

    if (existing) {
        existing.qty += 1;
        existing.model = selectedModel;
    } else {
        cart.push({ id: product.id, qty: 1, model: selectedModel });
    }

    localStorage.setItem("cart", JSON.stringify(cart));
    alert("Item added to cart!");
});

// Update cart counter instantly
const cartCountEl = document.getElementById("cart-count");
if (cartCountEl) {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
    cartCountEl.textContent = totalQty;
}