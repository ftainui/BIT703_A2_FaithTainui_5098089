// Wait for page load before running scripts
document.addEventListener("DOMContentLoaded", () => {

    // Prevent cart JS from running on other pages
    if (!document.getElementById("payment-form")) return;

    // Get card inputs
    const cardNumberInput = document.querySelector("input[name='cardNumber']");
    const cardExpiryInput = document.querySelector("input[name='cardExpiry']");
    const cardCVCInput = document.querySelector("input[name='cardCVC']");

    // Format card number
    cardNumberInput.addEventListener("input", () => {
        let value = cardNumberInput.value.replace(/\D/g, "");
        cardNumberInput.value = value.replace(/(.{4})/g, "$1 ").trim();
    });

    // -Format expiry date
    cardExpiryInput.addEventListener("input", () => {
        let value = cardExpiryInput.value.replace(/\D/g, "");

        let month = value.slice(0, 2);
        let year = value.slice(2, 4);

        // Prevent entering a month over 12
        if (month.length === 2) {
            if (parseInt(month) > 12) month = "12";
        }

        // Format / inbetween month and year
        cardExpiryInput.value = month + (year ? "/" + year : "");
    });

    // Only allow numbers in CVC
    cardCVCInput.addEventListener("input", () => {
        cardCVCInput.value = cardCVCInput.value.replace(/\D/g, "").slice(0, 4);
    });

    // Load cart summary
    const summaryContainer = document.getElementById("summary-items");
    const subtotalEl = document.getElementById("subtotal");
    const shippingEl = document.getElementById("shipping-cost");
    const taxesEl = document.getElementById("taxes");
    const totalEl = document.getElementById("total");

    // Load items and shipping address
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const shippingData = JSON.parse(localStorage.getItem("shippingAddress")) || {};

    // Build cart summary
    let subtotal = 0;
    summaryContainer.innerHTML = "";
    cart.forEach(item => {
        const product = products.find(p => p.id === item.id);
        if (!product) return;

        const row = document.createElement("div");
        row.className = "summary-item-row";
        row.innerHTML = `
            <div class="summary-item-image">
                <img src="${product.img}" alt="${product.name}">
            </div>
            <div class="summary-item-info">
                <span class="summary-item-name">${product.name}</span>
                <span class="summary-item-price">$${(product.price * item.qty).toFixed(2)}</span>
            </div>
        `;
        summaryContainer.appendChild(row);

        subtotal += product.price * item.qty;
    });

    // Calculate shipping
    const shippingCost = shippingData.shippingMethod === "nextday" ? 20 : 0;
    const taxes = subtotal * 0.15;
    const total = subtotal + shippingCost + taxes;

    // Update page
    subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
    shippingEl.textContent = `$${shippingCost.toFixed(2)}`;
    taxesEl.textContent = `$${taxes.toFixed(2)}`;
    totalEl.textContent = `$${total.toFixed(2)}`;


    // Back button
    document.getElementById("back-to-shipping").addEventListener("click", () => {
        window.location.href = "shipping_details.html";
    });

    // Pay now button
    document.getElementById("pay-now").addEventListener("click", () => {
        const selectedPayment = document.querySelector("input[name='payment']:checked").value;
        const paymentForm = document.getElementById("payment-form");
        const paymentData = { method: selectedPayment };
        let valid = true;

        // Validate credit card information if selected
        if (selectedPayment === "credit") {
            paymentForm.querySelectorAll("input").forEach(input => {
                input.style.borderColor = "#ccc"; 

                // Required check
                if (!input.value.trim()) {
                    input.style.borderColor = "red";
                    valid = false;
                }

                // Card number validation
                if (input.name === "cardNumber" && !/^\d{16}$/.test(input.value.replace(/\s+/g,''))) {
                    input.style.borderColor = "red";
                    valid = false;
                }

                // Expiry date validation
                if (input.name === "cardExpiry") {
                    const expiry = input.value;
                    const [month, year] = expiry.split("/").map(Number);
                    const now = new Date();
                    const currentMonth = now.getMonth() + 1;
                    const currentYear = now.getFullYear() % 100;

                    if (!month || !year || month < 1 || month > 12 || year < currentYear || (year === currentYear && month < currentMonth)) {
                        input.style.borderColor = "red";
                        valid = false;
                    }
                }

                // CVC validation
                if (input.name === "cardCVC" && !/^\d{3,4}$/.test(input.value)) {
                    input.style.borderColor = "red";
                    valid = false;
                }
            });

            // End if any fields empty
            if (!valid) {
                alert("Please correct the highlighted fields.");
                return;
            }

            // Save credit card info
            paymentForm.querySelectorAll("input").forEach(input => {
                paymentData[input.name] = input.value;
            });
        }

        // Save payment method
        localStorage.setItem("paymentInfo", JSON.stringify(paymentData));

        // Confirm purchase 
        alert("Purchase confirmed! Thank you for your order.");
        window.location.href = "index.html";
    });

    // Cart counter functionality
    const cartCountEl = document.getElementById("cart-count");
    if (cartCountEl) {
        const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
        cartCountEl.textContent = totalQty;
    }

});